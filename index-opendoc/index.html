<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="计算巢是阿里云开放给企业应用服务商的服务管理平台。服务商能够在计算巢上发布私有化部署服务，为其客户提供云上软件一键部署的能力；同时也支持全托管模式的服务，赋能服务商托管其客户资源。">
  <title>30分钟拉起Ray集群并部署Stable Diffusion模型服务 - Aliyun 计算巢 x Demo</title>

  <link rel="shortcut icon" href="../img/favicon.ico">

  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css">
  <link rel="stylesheet" href="../css/theme.css">
  

  

  
  

  
    <script src="../search/main.js"></script>
  

  

  <script src="../js/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
</head>

<body>
  <div class="container">
    <div class="nav">
      <div class="nav-inner">
        <div class="logo">
          <img src="./img/logo-2x.png">
        </div>
        <div class="nav-list">
          <ul>
          
              <li><a href="#30raystable-diffusion">30分钟拉起Ray集群并部署Stable Diffusion模型服务</a></li>
              
                  <li><a href="#ray">Ray 平台简介</a></li>
                  
              
                  <li><a href="#ray_1">Ray 的核心能力</a></li>
                  
                      <li class="li-h3"><a href="#1">1. 分布式计算</a></li>
                  
                      <li class="li-h3"><a href="#2">2. 模型训练和测试</a></li>
                  
                      <li class="li-h3"><a href="#3">3. 服务编排与部署</a></li>
                  
                      <li class="li-h3"><a href="#4">4. 大规模数据处理</a></li>
                  
              
                  <li><a href="#ray_2">Ray 的部署方式</a></li>
                  
                      <li class="li-h3"><a href="#_1">本地单机部署</a></li>
                  
                      <li class="li-h3"><a href="#_2">本地集群部署</a></li>
                  
                      <li class="li-h3"><a href="#_3">阿里云一键部署</a></li>
                  
              
                  <li><a href="#_8">更多信息</a></li>
                  
              
          
          </ul>
        </div>
      </div>
    </div>
    <div class="content theme-github">
      
      <div class="content-inner">        
        
        <h1 id="30raystable-diffusion">30分钟拉起Ray集群并部署Stable Diffusion模型服务</h1>
<h2 id="ray">Ray 平台简介</h2>
<p><strong><a href="https://www.ray.io/">Ray</a></strong> 是一个支持模型训练、测试以及部署的开源平台，由加州大学伯克利分校的 RISELab 开发。它旨在简化大规模机器学习、强化学习和分布式计算任务的开发与部署。Ray 的设计目标是提供高性能、灵活性和易用性，使开发者能够轻松构建和扩展复杂的分布式应用程序。无论是处理海量数据、训练深度学习模型，还是运行强化学习算法，Ray 都能提供强大的支持。
<img alt="img.png" src="../img1.png" /></p>
<p>Ray提供了大量的<a href="https://docs.ray.io/en/latest/ray-overview/getting-started.html">帮助文档</a>，其中包含许多示例和教程，帮助用户快速掌握如何通过Ray进行模型训练、测试和部署。
<img alt="img.png" src="../img3.png" /></p>
<p>还提供了大量适用于生产环境中的<a href="https://docs.ray.io/en/latest/ray-overview/examples.html">模型服务化的例子</a>，涉及大语言模型，强化学习，机器学习模型, 图像生成（Stable Diffusion），图像分类，文本分类和目标检测等众多领域和方向， 帮助模型开发者能够快速通过Ray构建和部署模型服务。
<img alt="img.png" src="../img2.png" /></p>
<hr />
<h2 id="ray_1">Ray 的核心能力</h2>
<h3 id="1">1. 分布式计算</h3>
<ul>
<li><strong>分布式训练</strong>：Ray 提供了分布式训练的能力，支持多机多卡的模型训练，显著缩短训练时间。</li>
<li><strong>并行任务执行</strong>：Ray 支持将任务分解为多个子任务，并在分布式环境中并行执行，从而高效处理大规模数据和计算密集型任务。</li>
<li><strong>动态任务调度</strong>：Ray 提供了一个灵活的任务调度器，可以根据资源需求动态分配计算资源，优化任务执行效率。</li>
<li><strong>容错机制</strong>：内置的容错机制能够在节点故障时自动恢复任务，确保系统的高可用性。</li>
</ul>
<h3 id="2">2. 模型训练和测试</h3>
<ul>
<li><strong>支持主流机器学习框架</strong>：Ray 可以与 TensorFlow、PyTorch 等主流机器学习框架无缝集成，加速模型训练和推理。</li>
<li><strong>支持强化学习</strong>：Ray 集成了 RLlib，这是一个强大的强化学习库，支持多种算法（如 DQN、PPO、A3C 等），适用于各种强化学习场景。</li>
<li><strong>高效仿真环境</strong>：Ray 可以与仿真环境（如 OpenAI Gym）结合，快速构建和测试强化学习模型。</li>
<li><strong>超参数调优</strong>：通过 Ray Tune（Ray 的超参数优化库），用户可以高效地进行超参数搜索，找到最优模型配置。</li>
</ul>
<h3 id="3">3. 服务编排与部署</h3>
<ul>
<li><strong>Ray Serve</strong>：Ray 提供了一个轻量级的服务编排框架（Ray Serve），用于部署和管理机器学习模型和服务。它支持多模型组合、动态扩展和低延迟推理。</li>
<li><strong>实时推理</strong>：Ray Serve 能够处理高并发的实时推理请求，适合生产环境中的模型服务化。</li>
</ul>
<h3 id="4">4. 大规模数据处理</h3>
<ul>
<li><strong>Ray Data</strong>：Ray 提供了一个分布式数据处理库（Ray Data），用于高效处理大规模数据集。它支持常见的数据操作（如过滤、映射、聚合等），并能与其他 Ray 组件无缝集成。</li>
<li><strong>与大数据生态兼容</strong>：Ray 可以与 Apache Spark 等大数据工具结合使用，进一步扩展其数据处理能力。</li>
</ul>
<hr />
<h2 id="ray_2">Ray 的部署方式</h2>
<p>通过以上介绍可以看出，Ray 是一个功能强大且灵活的分布式计算平台，适用于从机器学习到科学计算的广泛场景。它的高性能、易用性和丰富的生态系统使其成为开发者的首选工具之一。</p>
<p>那么，该如何部署和使用 Ray 呢？</p>
<h3 id="_1">本地单机部署</h3>
<p>Ray支持在不同操作系统下的<a href="https://docs.ray.io/en/latest/ray-overview/installation.html">本地部署</a>，且提供了python、Java、C++以及Docker等情况下的安装方式。</p>
<h3 id="_2">本地集群部署</h3>
<blockquote>
<p><strong>前提条件：</strong> 用户已有k8s集群或可自行创建k8s集群。</p>
</blockquote>
<p>由于单机场景下性能有限，难以支持生产场景下的模型训练，Ray还提供了开源的集群版本：<a href="https://github.com/ray-project/kuberay">KubeRay</a>。</p>
<p>用户可根据<a href="https://docs.ray.io/en/master/cluster/kubernetes/getting-started/raycluster-quick-start.html">RayCluster Quickstart</a>流程部署KubeRay，
可根据<a href="https://docs.ray.io/en/master/cluster/kubernetes/getting-started/rayjob-quick-start.html">RayJob Quickstart</a>体验如何通过KubeRay管理任务，
还可根据<a href="https://docs.ray.io/en/master/cluster/kubernetes/getting-started/rayservice-quick-start.html">RayService Quickstart</a>体验如何通过KubeRay部署用户应用。
仓库中还提供了一些生产环境中的示例应用，帮助用户快速了解KubeRay下的模型部署过程。
<img alt="img.png" src="../img4.png" /></p>
<h3 id="_3">阿里云一键部署</h3>
<blockquote>
<p><strong>前提条件：</strong> 开通阿里云账号。</p>
</blockquote>
<p>阿里云计算巢提供了Ray的一键部署服务，用户无需手动搭建Ray集群，仅需在创建实例后等待约10分钟，即可体验Ray集群的强大能力。</p>
<h4 id="_4">部署流程</h4>
<ol>
<li>点击<a href="https://computenest.console.aliyun.com/service/instance/create/cn-hangzhou?type=user&amp;ServiceName=Ray%E7%A4%BE%E5%8C%BA%E7%89%88">Ray一键部署</a>链接，
   进入创建Ray集群的页面。如没有阿里云账号需要先注册账号哦。</li>
<li>创建Ray集群时，首先选择新建ACK集群。服务实例名称将作为运行Ray平台的命名空间，将在模型服务部署时使用。
   <img alt="img.png" src="../img5.png" /></li>
<li>为保障Ray的流畅运行，Worker节点建议选择 8vCpu 16GiB 以上的规格。然后填写实例密码。
   <img alt="img.png" src="../img6.png" />
   模型部署基本都有Gpu需求，如果需要Gpu，请在此步选择有Gpu的规格。
   本文档在下一节演示了如何在Ray集群上部署Stable Diffusion模型服务，推荐使用ecs.gn7i-c8g1.2xlarge及以上规格，worker节点系统盘大小推荐1024GB以上。
   <img alt="img.png" src="../img22.png" /></li>
<li>选择任意一个可用区，然后点击 下一步：确认订单。
   <img alt="img.png" src="../img7.png" /></li>
<li>确认依赖权限已授权，如未授权，请点击授权。然后点击 立即创建
   <img alt="img.png" src="../img8.png" /></li>
<li>点击 去列表查看
   <img alt="img.png" src="../img9.png" /></li>
<li>跳转到计算巢控制台的服务实例界面后，请等待Ray集群创建完成，大约需要10分钟。
   <img alt="img.png" src="../img10.png" /></li>
<li>创建Ray集群完成后，点击 Ray集群名称进入Ray集群详情页面。
   <img alt="img.png" src="../img11.png" /></li>
<li>点击透出的web url，即可访问到Ray集群的Ray Dashboard。此时Ray集群已经成功运行，可通过 下一节：快速体验模型部署 了解如何在集群内部署自己的模型。
   <img alt="img.png" src="../img12.png" />
   <img alt="img.png" src="../img13.png" /></li>
</ol>
<h4 id="_5">体验模型服务部署</h4>
<p>通过阿里云创建Ray集群后，本节展示如何在Ray集群上部署一个基于 Stable Diffusion 的文本到图像生成服务。更多示例可参考[http://docs.ray.io/en/master/cluster/kubernetes/examples/stable-diffusion-rayservice.html#kuberay-stable-diffusion-rayservice-example)。</p>
<h5 id="_6">确认集群配置足够</h5>
<blockquote>
<p><strong>⚠️注意：</strong> 如果集群配置不够用，会导致Stable Diffusion模型服务部署失败。
1. 在Ray集群上部署Stable Diffusion模型服务，推荐使用ecs.gn7i-c8g1.2xlarge及以上规格，worker节点系统盘大小推荐1024GB以上。
   <img alt="img.png" src="../img22.png" /></p>
</blockquote>
<h5 id="ip">集群绑定公网IP(如果已绑定可跳过)</h5>
<blockquote>
<p><strong>⚠️注意：</strong> 如果不绑定公网IP，会导致Ray集群拉取模型文件失败，也会导致Ray集群无法提供对外服务。
1. 在服务实例详情页面，点击 资源 ，查看Ray集群的资源使用情况。
   <img alt="img.png" src="../img14.png" />
2. 找到k8s集群，点击名称进入k8s集群详情页面。
   <img alt="img.png" src="../img15.png" />
   <img alt="img.png" src="../img16.png" />
3. 点击 绑定公网IP ，选择已有EIP。如果没有EIP，点击创建EIP，创建完成后，返回该页面绑定公网IP。
   <img alt="img.png" src="../img20.png" />
   <img alt="img.png" src="../img21.png" /></p>
</blockquote>
<h5 id="kubectl-kubernetes">通过 kubectl 连接 Kubernetes 集群</h5>
<ol>
<li>在服务实例详情页面，点击 资源 ，查看Ray集群的资源使用情况。
   <img alt="img.png" src="../img14.png" /></li>
<li>找到k8s集群，点击名称进入k8s集群详情页面。
   <img alt="img.png" src="../img15.png" />
   <img alt="img.png" src="../img16.png" /></li>
<li>点击连接信息，查看kubeconfig文件。
   <img alt="img.png" src="../img17.png" /></li>
<li>点击 <a href="https://kubernetes.io/docs/tasks/tools/?spm=5176.28197681.0.0.5f425ff66rLatZ">安装和设置 kubectl</a> 。这是一个用本地设备管理k8s集群的工具。可根据自身操作系统选择对应的安装方式。
   <img alt="img.png" src="../img18.png" />
   <img alt="img.png" src="../img19.png" /></li>
<li>在本地设备上执行以下命令或自行在目录路径下手动创建$HOME/.kube/config文件，并将kubeconfig文件内容粘贴到该文件中。
    ```bash
   sudo mkdir -p $HOME/.kube
   sudo touch $HOME/.kube/config
   sudo chmod 777 $HOME/.kube/config
   vim $HOME/.kube/config</li>
</ol>
<h5 id="_7">部署模型服务</h5>
<ol>
<li>
<p>将kubeconfig文件内容粘贴到该文件中后，在本地设备上执行以下命令。--namespace={$服务实例名称}，需要替换为Ray集群名称。
   如笔者的Ray集群名称为kuberay-tdhrtg，因此下面的指令替换为sudo kubectl config set-context --current --namespace=kuberay-tdhrtg
   ```bash
   sudo kubectl config set-context --current --namespace={$Ray集群名称}</p>
</li>
<li>
<p>在本地依次执行以下命令。对应<a href="https://docs.ray.io/en/master/cluster/kubernetes/examples/stable-diffusion-rayservice.html">Ray官方教程</a>从Step 3之后的部分。
   <code>``bash
   kubectl apply -f https://raw.githubusercontent.com/ray-project/kuberay/master/ray-operator/config/samples/ray-service.stable-diffusion.yaml
   kubectl get pods
   # Wait until the RayService</code>Ready<code>condition is</code>True`. This means the RayService is ready to serve.
   kubectl describe rayservices.ray.io stable-diffusion
   # Forward the port of Serve
   kubectl port-forward svc/stable-diffusion-serve-svc 8000</p>
</li>
</ol>
<p># Download <code>stable_diffusion_req.py</code>
   curl -LO https://raw.githubusercontent.com/ray-project/serve_config_examples/master/stable_diffusion/stable_diffusion_req.py</p>
<p># Set your <code>prompt</code> in <code>stable_diffusion_req.py</code>.</p>
<p># Send a request to the Stable Diffusion model.
   python stable_diffusion_req.py
   ```
   kubectl apply部署Stable Diffusion约需要15分钟。
   <img alt="img.png" src="../img26.png" />
3. 运行python stable_diffusion_req.py后，模型会输出一张名为output.png的图片。此时，Stable Diffusion模型服务部署完成。
   <img alt="img.png" src="../img23.png" /></p>
<ol>
<li>output.png如下图所示。
   <img alt="img.png" src="../img24.png" /></li>
</ol>
<hr />
<h2 id="_8">更多信息</h2>
<ol>
<li><a href="https://www.ray.io/">Ray官网</a></li>
<li><a href="https://github.com/ray-project/ray">Ray单机版开源库</a></li>
<li><a href="https://github.com/ray-project/kuberay">Ray集群版开源库</a></li>
<li><a href="https://docs.ray.io/en/latest/ray-overview/getting-started.html">Ray QuickStart帮助文档</a></li>
<li><a href="https://docs.ray.io/en/latest/ray-overview/examples.html">Ray 模型服务化示例文档</a></li>
</ol>
        
      </div>

      <div class="copyrights">© 2009-2022 Aliyun.com 版权所有</div>
    </div>
  </div>
  
  <!--
  MkDocs version      : 1.6.1
  Docs Build Date UTC : 2025-05-19 09:22:41.337567+00:00
  -->
</body>
</html>